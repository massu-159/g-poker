{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "ごきぶりポーカー WebSocket API Contract",
  "description": "Real-time event schemas for multiplayer card game communication",
  "version": "1.0.0",
  
  "definitions": {
    "CreatureType": {
      "type": "string",
      "enum": ["cockroach", "mouse", "bat", "frog"],
      "description": "Available creature types in the game"
    },
    
    "ResponseType": {
      "type": "string", 
      "enum": ["believe", "disbelieve", "pass_back"],
      "description": "Player response options to card claims"
    },
    
    "GameStatus": {
      "type": "string",
      "enum": ["waiting_for_players", "in_progress", "ended", "abandoned"],
      "description": "Current state of the game"
    },
    
    "Card": {
      "type": "object",
      "properties": {
        "id": {"type": "string", "format": "uuid"},
        "creatureType": {"$ref": "#/definitions/CreatureType"},
        "imageUrl": {"type": "string", "format": "uri"}
      },
      "required": ["id", "creatureType", "imageUrl"],
      "additionalProperties": false
    },
    
    "Player": {
      "type": "object", 
      "properties": {
        "id": {"type": "string", "format": "uuid"},
        "displayName": {
          "type": "string",
          "minLength": 1,
          "maxLength": 20,
          "pattern": "^[a-zA-Z0-9 ]+$"
        },
        "isConnected": {"type": "boolean"},
        "penaltyPile": {
          "type": "object",
          "properties": {
            "cockroach": {"type": "array", "items": {"$ref": "#/definitions/Card"}},
            "mouse": {"type": "array", "items": {"$ref": "#/definitions/Card"}},
            "bat": {"type": "array", "items": {"$ref": "#/definitions/Card"}},
            "frog": {"type": "array", "items": {"$ref": "#/definitions/Card"}}
          },
          "required": ["cockroach", "mouse", "bat", "frog"],
          "additionalProperties": false
        }
      },
      "required": ["id", "displayName", "isConnected", "penaltyPile"],
      "additionalProperties": false
    },
    
    "Game": {
      "type": "object",
      "properties": {
        "id": {"type": "string", "format": "uuid"},
        "status": {"$ref": "#/definitions/GameStatus"},
        "players": {
          "type": "array",
          "items": {"$ref": "#/definitions/Player"},
          "minItems": 1,
          "maxItems": 2
        },
        "currentTurn": {"type": "string", "format": "uuid"},
        "createdAt": {"type": "string", "format": "date-time"},
        "startedAt": {"type": "string", "format": "date-time"},
        "endedAt": {"type": "string", "format": "date-time"},
        "winnerId": {"type": "string", "format": "uuid"}
      },
      "required": ["id", "status", "players", "createdAt"],
      "additionalProperties": false
    },
    
    "Round": {
      "type": "object",
      "properties": {
        "id": {"type": "string", "format": "uuid"},
        "cardInPlay": {"$ref": "#/definitions/Card"},
        "initiatingPlayerId": {"type": "string", "format": "uuid"},
        "targetPlayerId": {"type": "string", "format": "uuid"},
        "claim": {"$ref": "#/definitions/CreatureType"},
        "response": {
          "type": "object",
          "properties": {
            "type": {"$ref": "#/definitions/ResponseType"},
            "timestamp": {"type": "string", "format": "date-time"},
            "playerId": {"type": "string", "format": "uuid"}
          },
          "required": ["type", "timestamp", "playerId"],
          "additionalProperties": false
        },
        "createdAt": {"type": "string", "format": "date-time"}
      },
      "required": ["id", "cardInPlay", "initiatingPlayerId", "targetPlayerId", "claim", "createdAt"],
      "additionalProperties": false
    }
  },
  
  "clientEvents": {
    "join-game": {
      "type": "object",
      "properties": {
        "gameId": {"type": "string", "format": "uuid"},
        "playerId": {"type": "string", "format": "uuid"},
        "displayName": {
          "type": "string",
          "minLength": 1,
          "maxLength": 20,
          "pattern": "^[a-zA-Z0-9 ]+$"
        }
      },
      "required": ["playerId", "displayName"],
      "additionalProperties": false,
      "description": "Player requests to join a game. gameId optional for matchmaking."
    },
    
    "play-card": {
      "type": "object", 
      "properties": {
        "cardId": {"type": "string", "format": "uuid"},
        "targetPlayerId": {"type": "string", "format": "uuid"},
        "claim": {"$ref": "#/definitions/CreatureType"}
      },
      "required": ["cardId", "targetPlayerId", "claim"],
      "additionalProperties": false,
      "description": "Player plays a card from hand with a creature claim"
    },
    
    "respond-to-round": {
      "type": "object",
      "properties": {
        "roundId": {"type": "string", "format": "uuid"},
        "response": {"$ref": "#/definitions/ResponseType"}
      },
      "required": ["roundId", "response"],
      "additionalProperties": false,
      "description": "Player responds to opponent's card claim"
    },
    
    "leave-game": {
      "type": "object",
      "properties": {
        "gameId": {"type": "string", "format": "uuid"},
        "playerId": {"type": "string", "format": "uuid"}
      },
      "required": ["gameId", "playerId"],
      "additionalProperties": false,
      "description": "Player leaves the current game"
    }
  },
  
  "serverEvents": {
    "game-joined": {
      "type": "object",
      "properties": {
        "game": {"$ref": "#/definitions/Game"},
        "yourPlayerId": {"type": "string", "format": "uuid"},
        "yourHand": {
          "type": "array",
          "items": {"$ref": "#/definitions/Card"},
          "maxItems": 9
        }
      },
      "required": ["game", "yourPlayerId", "yourHand"],
      "additionalProperties": false,
      "description": "Confirmation of successful game join with initial state"
    },
    
    "game-state-update": {
      "type": "object",
      "properties": {
        "game": {"$ref": "#/definitions/Game"},
        "yourHand": {
          "type": "array",
          "items": {"$ref": "#/definitions/Card"}
        },
        "isYourTurn": {"type": "boolean"},
        "cardsRemainingInDeck": {"type": "integer", "minimum": 0, "maximum": 6}
      },
      "required": ["game", "yourHand", "isYourTurn", "cardsRemainingInDeck"],
      "additionalProperties": false,
      "description": "Periodic full game state synchronization"
    },
    
    "round-started": {
      "type": "object",
      "properties": {
        "round": {"$ref": "#/definitions/Round"},
        "isYourTurn": {"type": "boolean"},
        "timeLimit": {"type": "integer", "description": "Response timeout in seconds"}
      },
      "required": ["round", "isYourTurn", "timeLimit"],
      "additionalProperties": false,
      "description": "New round initiated, player must respond"
    },
    
    "round-completed": {
      "type": "object",
      "properties": {
        "round": {"$ref": "#/definitions/Round"},
        "outcome": {
          "type": "object",
          "properties": {
            "penaltyReceiver": {"type": "string", "format": "uuid"},
            "correctGuess": {"type": "boolean"},
            "gameEnding": {"type": "boolean"}
          },
          "required": ["penaltyReceiver", "correctGuess", "gameEnding"],
          "additionalProperties": false
        },
        "updatedGame": {"$ref": "#/definitions/Game"}
      },
      "required": ["round", "outcome", "updatedGame"],
      "additionalProperties": false,
      "description": "Round resolution with penalty assignment"
    },
    
    "game-ended": {
      "type": "object",
      "properties": {
        "winnerId": {"type": "string", "format": "uuid"},
        "reason": {
          "type": "string",
          "enum": ["penalty_limit_reached", "opponent_disconnected", "forfeit"]
        },
        "finalGame": {"$ref": "#/definitions/Game"}
      },
      "required": ["winnerId", "reason", "finalGame"],
      "additionalProperties": false,
      "description": "Game completion with winner and final state"
    },
    
    "player-disconnected": {
      "type": "object",
      "properties": {
        "playerId": {"type": "string", "format": "uuid"},
        "reconnectionTimeLeft": {"type": "integer", "description": "Seconds until forfeit"}
      },
      "required": ["playerId", "reconnectionTimeLeft"],
      "additionalProperties": false,
      "description": "Opponent disconnected, waiting for reconnection"
    },
    
    "error": {
      "type": "object",
      "properties": {
        "code": {
          "type": "string",
          "enum": [
            "INVALID_GAME_ID",
            "GAME_FULL", 
            "NOT_YOUR_TURN",
            "INVALID_CARD",
            "CARD_NOT_IN_HAND",
            "INVALID_RESPONSE",
            "ROUND_NOT_FOUND",
            "PLAYER_NOT_IN_GAME",
            "GAME_NOT_IN_PROGRESS",
            "CONNECTION_ERROR",
            "VALIDATION_ERROR"
          ]
        },
        "message": {"type": "string", "maxLength": 200},
        "context": {
          "type": "object",
          "description": "Additional error context (optional)"
        }
      },
      "required": ["code", "message"],
      "additionalProperties": false,
      "description": "Error response with specific error code and message"
    }
  },
  
  "rateLimits": {
    "join-game": {"maxPerMinute": 10},
    "play-card": {"maxPerMinute": 30},
    "respond-to-round": {"maxPerMinute": 30},
    "leave-game": {"maxPerMinute": 5}
  },
  
  "timeouts": {
    "roundResponse": 60,
    "reconnectionGrace": 30,
    "gameInactivity": 300
  }
}